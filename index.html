<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>科学范式转变与 AI 时代的认识论革命</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* 基础样式 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
      margin: 0; 
      background: #f5f7fa; 
      color: #222; 
      line-height: 1.7; 
      padding-bottom: 80px;
    }
    header {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white; 
      padding: 2.5rem 1.5rem; 
      text-align: center; 
      position: relative;
    }
    .lang-toggle {
      position: absolute; 
      top: 20px; 
      right: 20px; 
      background: rgba(255,255,255,0.2);
      border: 1px solid white; 
      color: white; 
      padding: 5px 15px; 
      cursor: pointer; 
      border-radius: 20px; 
      font-size: 0.8rem;
    }
    main { 
      max-width: 900px; 
      margin: auto; 
      padding: 2rem 1.5rem; 
    }
    section {
      background: white; 
      border-radius: 12px; 
      padding: 1.8rem; 
      margin-bottom: 2rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    h2 { 
      border-left: 6px solid #2a5298; 
      padding-left: 0.6rem; 
      margin-top: 0; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
    }
    h3 { 
      color: #1e3c72; 
      margin-bottom: 0.4rem; 
    }
    .meta { 
      color: #555; 
      font-size: 0.95rem; 
      margin-bottom: 0.8rem; 
    }
    .highlight { 
      background: #eef3ff; 
      border-left: 4px solid #2a5298; 
      padding: 0.8rem 1rem; 
      margin-top: 1rem; 
      border-radius: 6px; 
    }
    
    /* 链接与图标 */
    .info-link { 
      font-size: 0.75rem; 
      color: #2a5298; 
      text-decoration: none; 
      border-bottom: 1px dashed #2a5298; 
      margin-left: 8px; 
    }
    .tts-icon { 
      cursor: pointer; 
      color: #2a5298; 
      transition: all 0.3s; 
    }
    .tts-icon.playing { 
      color: #ff4757; 
      animation: pulse 1.5s infinite; 
    }

    /* AI 对话框样式 */
    #ai-btn {
      position: fixed; 
      bottom: 25px; 
      right: 25px; 
      width: 56px; 
      height: 56px;
      background: #1e3c72; 
      color: white; 
      border-radius: 50%; 
      display: flex;
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
      z-index: 1001;
    }
    #ai-panel {
      position: fixed; 
      bottom: 90px; 
      right: 25px; 
      width: 340px; 
      height: 480px;
      background: white; 
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
      z-index: 1000;
      display: none;
    }
    #ai-panel.active {
      display: flex;
    }
    .ai-header { 
      background: #1e3c72; 
      color: white; 
      padding: 15px; 
      font-weight: bold; 
      display: flex; 
      justify-content: space-between; 
    }
    .ai-body { 
      flex: 1; 
      padding: 15px; 
      overflow-y: auto; 
      background: #f9f9fb; 
      font-size: 0.9rem; 
    }
    .msg { 
      margin-bottom: 12px; 
      padding: 8px 12px; 
      border-radius: 10px; 
      max-width: 85%; 
      word-break: break-word;
    }
    .msg.user { 
      background: #2a5298; 
      color: white; 
      align-self: flex-end; 
      margin-left: auto; 
    }
    .msg.ai { 
      background: #e9e9eb; 
      color: #222; 
      position: relative;
    }
    .ai-footer { 
      padding: 10px; 
      border-top: 1px solid #eee; 
      display: flex; 
      gap: 8px; 
    }
    .ai-footer input { 
      flex: 1; 
      border: 1px solid #ddd; 
      padding: 8px 12px; 
      border-radius: 20px; 
      outline: none; 
      font-size: 0.9rem;
    }
    .ai-footer button {
      background: #2a5298; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 20px; 
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* 思考动画 */
    .dot-loader { 
      display: inline-flex; 
      gap: 3px; 
    }
    .dot-loader span { 
      width: 6px; 
      height: 6px; 
      background: #999; 
      border-radius: 50%; 
      animation: bounce 1.4s infinite ease-in-out; 
    }
    .dot-loader span:nth-child(2) { 
      animation-delay: 0.2s; 
    }
    .dot-loader span:nth-child(3) { 
      animation-delay: 0.4s; 
    }
    
    /* 消息TTS样式 */
    .message-content {
      position: relative;
      padding-right: 24px;
      word-break: break-word;
    }
    
    .message-tts {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 0.8rem;
      color: #666;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 2px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.7);
    }
    
    .message-tts:hover {
      opacity: 1;
      color: #2a5298;
      background-color: rgba(42, 82, 152, 0.1);
    }
    
    .message-tts.playing {
      color: #ff4757;
      opacity: 1;
      animation: pulse 1.5s infinite;
      background-color: rgba(255, 71, 87, 0.1);
    }
    
    /* 用户消息不需要TTS按钮 */
    .msg.user .message-tts {
      display: none;
    }
    
    /* 思考状态不显示TTS按钮 */
    .msg.ai .dot-loader + .message-tts {
      display: none;
    }
    
    /* 动画定义 */
    @keyframes bounce { 
      0%, 80%, 100% { transform: scale(0); } 
      40% { transform: scale(1); } 
    }
    @keyframes pulse { 
      0% { opacity: 1; } 
      50% { opacity: 0.4; } 
      100% { opacity: 1; } 
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      main {
        padding: 1rem;
      }
      section {
        padding: 1.2rem;
      }
      #ai-panel {
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
        height: 60vh;
      }
      #ai-btn {
        right: 20px;
        bottom: 20px;
      }
      .message-tts {
        top: 2px;
        right: 2px;
        font-size: 0.7rem;
        padding: 1px;
      }
    }
    
    /* 列表样式 */
    ul {
      padding-left: 1.2rem;
      margin: 0.5rem 0;
    }
    li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }
    
    /* 滚动条样式 */
    .ai-body::-webkit-scrollbar {
      width: 6px;
    }
    .ai-body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .ai-body::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    /* 通知样式 */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #2a5298;
      color: white;
      border-radius: 8px;
      z-index: 2000;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
    }
    
    .notification.error {
      background: #ff4757;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>

<div id="app">
  <header>
    <button class="lang-toggle" @click="toggleLanguage">
      {{ lang === 'zh' ? 'English' : '中文' }}
    </button>
    <h1>{{ t.headerTitle }}</h1>
    <p>{{ t.headerSub }}</p>
    <p style="font-size: 0.9rem; opacity: 0.8;">{{ t.author }}</p>
  </header>

  <main>
    <section v-for="(section, idx) in t.sections" :key="idx">
      <h2>
        {{ section.title }}
        <i class="fas fa-volume-up tts-icon" 
           :class="{playing: playingIdx === idx}" 
           @click="toggleTTS(section.ttsText, idx)"
           :title="lang === 'zh' ? '朗读' : 'Read aloud'"></i>
      </h2>
      
      <div v-if="section.time">
        <h3>{{ t.labelTime }}</h3>
        <p class="meta">{{ section.time }}</p>
      </div>
      
      <div v-if="section.people">
        <h3>{{ t.labelPeople }}</h3>
        <p class="meta">{{ section.people }}</p>
      </div>
      
      <h3 v-if="section.featuresTitle">{{ section.featuresTitle }}</h3>
      
      <ul v-if="section.items">
        <li v-for="(item, itemIdx) in section.items" :key="itemIdx">
          {{ item.name }}
          <a :href="item.link" target="_blank" class="info-link" 
             :title="lang === 'zh' ? '了解更多' : 'Learn more'">
            [Info]
          </a>
        </li>
      </ul>
      
      <p v-if="section.description">{{ section.description }}</p>
      
      <div v-if="section.highlight" class="highlight" v-html="section.highlight"></div>
    </section>
  </main>

  <!-- AI 聊天面板 -->
  <div id="ai-panel" :class="{active: chatOpen}">
    <div class="ai-header">
      <span>{{ lang === 'zh' ? 'DeepSeek AI 助手' : 'DeepSeek AI Assistant' }}</span>
      <i class="fas fa-times" @click="closeChat" style="cursor:pointer"></i>
    </div>
    <div class="ai-body" ref="chatScroll">
      <div v-for="(message, msgIdx) in messages" :key="msgIdx" 
           :class="['msg', message.role]">
        <div class="message-content">
          {{ message.content }}
          <!-- 只在AI回复且内容非空时显示TTS按钮 -->
          <i v-if="message.role === 'ai' && message.content && message.content.trim().length > 0" 
             class="fas fa-volume-up message-tts"
             :class="{playing: ttsPlayingIndex === msgIdx}"
             @click="speakMessage(message.content, msgIdx)"
             :title="lang === 'zh' ? '朗读此消息' : 'Read this message aloud'"></i>
        </div>
      </div>
      
      <!-- 思考状态 -->
      <div v-if="isThinking" class="msg ai">
        <div class="dot-loader">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
    
    <div class="ai-footer">
      <input v-model="userInput" 
             @keyup.enter="sendMessage" 
             :placeholder="lang === 'zh' ? '输入您的问题...' : 'Type your question...'"
             :disabled="isThinking">
      <button @click="sendMessage" :disabled="isThinking || !userInput.trim()">
        <i class="fas fa-paper-plane"></i>
        <span v-if="lang === 'zh'">发送</span>
        <span v-else>Send</span>
      </button>
    </div>
  </div>
  
  <!-- AI 按钮 -->
  <div id="ai-btn" @click="toggleChat">
    <i class="fas fa-robot"></i>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      lang: 'zh',
      playingIdx: null,      // 章节朗读索引
      ttsPlayingIndex: null, // AI消息朗读索引
      chatOpen: false,
      userInput: '',
      isThinking: false,
      messages: [],
      currentSpeech: null,   // 当前语音对象
      content: {
        zh: {
          headerTitle: "科学范式转变：从自然哲学到 AI 时代",
          headerSub: "基于托马斯·库恩《科学革命的结构》，重新理解人类科学发展的断裂点",
          author: "天津财经大学统计学院教授 龚凤乾",
          labelTime: "时间", 
          labelPeople: "代表人物",
          sections: [
            {
              title: "什么是科学范式？",
              description: "在托马斯·库恩看来，范式（Paradigm）不是某一条具体的理论，而是一个科学共同体所共享的整体框架。这个框架决定了：什么问题是'科学的'、应当使用什么方法进行研究、什么样的解释是可接受的、以及什么标准决定成功或失败。",
              highlight: "科学革命并非知识的线性积累，而是范式之间的'断裂式跃迁'。",
              ttsText: "什么是科学范式？在库恩看来，范式不是某一条理论，而是一个科学共同体所共享的整体框架。科学革命并非知识的线性积累，而是范式之间的断裂式跃迁。"
            },
            {
              title: "第一次范式转变：亚里士多德自然哲学",
              time: "公元前 4 世纪 – 16 世纪",
              featuresTitle: "核心特征",
              items: [
                { name: "定性解释优先", link: "https://zh.wikipedia.org/wiki/定性研究" },
                { name: "目的论（事物'为何如此'）", link: "https://zh.wikipedia.org/wiki/目的论" },
                { name: "日常经验 + 逻辑推理", link: "https://zh.wikipedia.org/wiki/亚里士多德" }
              ],
              highlight: "世界被理解为一个'有目的、有意义'的有机整体。",
              ttsText: "第一次范式转变，亚里士多德自然哲学。时间从公元前4世纪到16世纪。核心特征是定性解释优先、目的论、日常经验加逻辑推理。"
            },
            {
              title: "第二次范式转变：经典科学革命",
              people: "哥白尼、伽利略、牛顿",
              featuresTitle: "核心变化",
              items: [
                { name: "数学化自然", link: "https://zh.wikipedia.org/wiki/自然哲学的数学原理" },
                { name: "实验 + 精确测量", link: "https://zh.wikipedia.org/wiki/科学实验" },
                { name: "因果—力学解释", link: "https://zh.wikipedia.org/wiki/牛顿力学" }
              ],
              highlight: "自然首次被视为'可计算的机器'，现代科学正式诞生。",
              ttsText: "第二次范式转变，经典科学革命。代表人物有哥白尼、伽利略、牛顿。核心变化是数学化自然、实验加精确测量、因果力学解释。"
            },
            {
              title: "第三次范式转变：化学与生命科学",
              time: "18–19 世纪",
              featuresTitle: "意义",
              items: [
                { name: "实验可重复性成为核心标准", link: "https://zh.wikipedia.org/wiki/可重复性" },
                { name: "分类、结构、机理研究", link: "https://zh.wikipedia.org/wiki/化学革命" },
                { name: "生命现象进入科学解释范围", link: "https://zh.wikipedia.org/wiki/生命科学史" }
              ],
              highlight: "科学不再只研究'运动'，而开始系统研究'结构与功能'。",
              ttsText: "第三次范式转变，化学与生命科学。时间是18到19世纪。意义包括实验可重复性成为核心标准、分类结构机理研究、生命现象进入科学解释范围。"
            },
            {
              title: "第四次范式转变：现代物理学",
              people: "相对论 & 量子力学",
              featuresTitle: "根本冲击",
              items: [
                { name: "确定性被打破", link: "https://zh.wikipedia.org/wiki/量子力学" },
                { name: "观察者进入理论结构", link: "https://zh.wikipedia.org/wiki/观测者效应" },
                { name: "直觉与数学彻底分离", link: "https://zh.wikipedia.org/wiki/现代物理学" }
              ],
              highlight: "人类首次承认：自然并不服从日常直觉与常识。",
              ttsText: "第四次范式转变，现代物理学。代表是相对论和量子力学。根本冲击包括确定性被打破、观察者进入理论结构、直觉与数学彻底分离。"
            },
            {
              title: "第五次范式转变：计算与系统科学",
              time: "20世纪后期至今",
              featuresTitle: "关键词",
              items: [
                { name: "仿真取代理论推导", link: "https://zh.wikipedia.org/wiki/计算科学" },
                { name: "非线性与涌现", link: "https://zh.wikipedia.org/wiki/复杂系统" },
                { name: "跨学科系统方法", link: "https://zh.wikipedia.org/wiki/系统科学" }
              ],
              highlight: "计算成为继实验与理论之后的'第三种科学方法'。",
              ttsText: "第五次范式转变，计算与系统科学。时间是20世纪后期至今。关键词包括仿真取代理论推导、非线性与涌现、跨学科系统方法。"
            },
            {
              title: "第六次（进行中）：AI 与数据驱动范式",
              featuresTitle: "根本特征",
              items: [
                { name: "预测优先于解释", link: "https://zh.wikipedia.org/wiki/人工智能" },
                { name: "模型由机器生成", link: "https://zh.wikipedia.org/wiki/机器学习" },
                { name: "假设不再是必需起点", link: "https://zh.wikipedia.org/wiki/数据驱动科学" }
              ],
              highlight: "AI 不只是新工具，而是在重塑'什么是科学知识'的认识论基础。",
              ttsText: "第六次范式转变，人工智能与数据驱动。特征是预测优先于解释、模型由机器生成、假设不再是必需起点。"
            },
            {
              title: "结语：我们正处在范式转换期",
              description: "按照库恩的标准，AI 引发的并非一次普通技术升级，而是一场方法论—认识论层面的科学革命。它是否会彻底改变'理解'、'解释'、'真理'的含义，将由我们这一代科学共同体共同决定。",
              highlight: "我们正经历一场深刻的科学认识论变革，其意义不亚于哥白尼革命。",
              ttsText: "结语，我们正处在范式转换期。按照库恩的标准，AI引发的并非一次普通技术升级，而是一场方法论认识论层面的科学革命。"
            }
          ]
        },
        en: {
          headerTitle: "Scientific Paradigm Shifts",
          headerSub: "Rethinking Scientific Revolutions based on Thomas Kuhn's Theory",
          author: "Prof. Gong Fengqian, Tianjin University of Finance and Economics",
          labelTime: "Timeline", 
          labelPeople: "Key Figures",
          sections: [
            {
              title: "What is a Scientific Paradigm?",
              description: "According to Thomas Kuhn, a Paradigm is not a specific theory but the overall framework shared by a scientific community. This framework determines: what questions are 'scientific', what methods should be used, what explanations are acceptable, and what standards define success or failure.",
              highlight: "Scientific revolutions are not linear accumulation of knowledge, but 'discontinuous leaps' between paradigms.",
              ttsText: "What is a scientific paradigm? According to Kuhn, a paradigm is not a single theory but the overall framework shared by a scientific community."
            },
            {
              title: "1st Paradigm: Aristotelian Natural Philosophy",
              time: "4th Century BC – 16th Century",
              featuresTitle: "Core Characteristics",
              items: [
                { name: "Qualitative Explanation First", link: "https://en.wikipedia.org/wiki/Qualitative_research" },
                { name: "Teleology (Purpose of Things)", link: "https://en.wikipedia.org/wiki/Teleology" },
                { name: "Everyday Experience + Logic", link: "https://en.wikipedia.org/wiki/Aristotle" }
              ],
              highlight: "The world was understood as a purposeful, meaningful organic whole.",
              ttsText: "First paradigm shift, Aristotelian natural philosophy."
            },
            {
              title: "2nd Paradigm: Classical Scientific Revolution",
              people: "Copernicus, Galileo, Newton",
              featuresTitle: "Core Changes",
              items: [
                { name: "Mathematization of Nature", link: "https://en.wikipedia.org/wiki/Mathematical_Principles_of_Natural_Philosophy" },
                { name: "Experiment + Measurement", link: "https://en.wikipedia.org/wiki/Scientific_method" },
                { name: "Mechanical Explanation", link: "https://en.wikipedia.org/wiki/Newtonian_mechanics" }
              ],
              highlight: "Nature was first viewed as a 'computable machine', marking the birth of modern science.",
              ttsText: "Second paradigm shift, Classical Scientific Revolution."
            },
            {
              title: "3rd Paradigm: Chemistry & Life Sciences",
              time: "18th–19th Century",
              featuresTitle: "Significance",
              items: [
                { name: "Repeatability as Core Standard", link: "https://en.wikipedia.org/wiki/Reproducibility" },
                { name: "Classification, Structure, Mechanism", link: "https://en.wikipedia.org/wiki/Chemical_revolution" },
                { name: "Life Phenomena Enter Science", link: "https://en.wikipedia.org/wiki/History_of_biology" }
              ],
              highlight: "Science began systematically studying 'structure and function', not just motion.",
              ttsText: "Third paradigm shift, Chemistry and Life Sciences."
            },
            {
              title: "4th Paradigm: Modern Physics",
              people: "Relativity & Quantum Mechanics",
              featuresTitle: "Fundamental Impact",
              items: [
                { name: "Determinism Broken", link: "https://en.wikipedia.org/wiki/Quantum_mechanics" },
                { name: "Observer in Theory", link: "https://en.wikipedia.org/wiki/Observer_effect" },
                { name: "Intuition Separated from Math", link: "https://en.wikipedia.org/wiki/Modern_physics" }
              ],
              highlight: "Humanity first admitted: nature does not obey common sense.",
              ttsText: "Fourth paradigm shift, Modern Physics."
            },
            {
              title: "5th Paradigm: Computational & Systems Science",
              time: "Late 20th Century – Present",
              featuresTitle: "Keywords",
              items: [
                { name: "Simulation Replaces Theory", link: "https://en.wikipedia.org/wiki/Computational_science" },
                { name: "Non-linearity & Emergence", link: "https://en.wikipedia.org/wiki/Complex_systems" },
                { name: "Interdisciplinary Systems", link: "https://en.wikipedia.org/wiki/Systems_science" }
              ],
              highlight: "Computation became the 'third scientific method' after experiment and theory.",
              ttsText: "Fifth paradigm shift, Computational and Systems Science."
            },
            {
              title: "6th (Ongoing): AI & Data-Driven Paradigm",
              featuresTitle: "Fundamental Features",
              items: [
                { name: "Prediction Over Explanation", link: "https://en.wikipedia.org/wiki/Artificial_intelligence" },
                { name: "Machine-Generated Models", link: "https://en.wikipedia.org/wiki/Machine_learning" },
                { name: "Hypothesis Not Required", link: "https://en.wikipedia.org/wiki/Data-driven_science" }
              ],
              highlight: "AI is not just a tool; it is reshaping the epistemological foundation of scientific knowledge.",
              ttsText: "Sixth paradigm shift, AI and Data-Driven Paradigm."
            },
            {
              title: "Conclusion: We Are in a Paradigm Shift",
              description: "By Kuhn's standards, AI represents not just a technological upgrade but a scientific revolution at the methodological and epistemological level. Whether it will fundamentally change the meanings of 'understanding', 'explanation', and 'truth' will be determined by our scientific community.",
              highlight: "We are experiencing a profound epistemological transformation in science.",
              ttsText: "Conclusion: we are in a paradigm shift period."
            }
          ]
        }
      }
    }
  },
  
  computed: {
    t() {
      return this.content[this.lang];
    }
  },
  
  mounted() {
    // 初始化消息
    this.messages = [
      {
        role: 'ai',
        content: this.lang === 'zh' 
          ? '你好！我是 AI 助手，我们可以探讨托马斯·库恩的科学范式理论、科学革命的结构，以及 AI 时代如何引发新的认识论变革。请随时提问！'
          : 'Hello! I am an AI assistant. We can discuss Thomas Kuhn\'s theory of scientific paradigms, the structure of scientific revolutions, and how the AI era is triggering new epistemological changes. Feel free to ask anything!'
      }
    ];
    
    // 预加载语音
    this.loadVoices();
    
    // 监听语音变化
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = () => {
        this.loadVoices();
      };
    }
  },
  
  methods: {
    // 加载语音
    loadVoices() {
      if ('speechSynthesis' in window) {
        const voices = window.speechSynthesis.getVoices();
        console.log('Available voices:', voices.length);
      }
    },
    
    // 核心功能：清理文本，移除标点符号和表情符号
    cleanTextForSpeech(text) {
      if (!text || typeof text !== 'string') return '';
      
      // 1. 移除所有表情符号和特殊符号
      // Unicode范围：表情符号、杂项符号、装饰符号等
      let cleaned = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, ' ') // 表情符号
                       .replace(/[\u{1F600}-\u{1F64F}]/gu, ' ') // 表情符号
                       .replace(/[\u{2700}-\u{27BF}]/gu, ' ')   // 装饰符号
                       .replace(/[\u{1F680}-\u{1F6FF}]/gu, ' ') // 交通和地图符号
                       .replace(/[\u{2600}-\u{26FF}]/gu, ' ')   // 杂项符号
                       .replace(/[\u{1F100}-\u{1F1FF}]/gu, ' '); // 封闭式字母数字
      
      // 2. 移除所有标点符号（保留空格）
      // 中文标点：，。！？；："「」『』【】《》（）〔〕［］｛｝
      // 英文标点：,.!?;:"'`~@#$%^&*()-_=+[]\{\}|\\<>/
      cleaned = cleaned.replace(/[，。！？；："「」『』【】《》（）〔〕［］｛｝,.!?;:"'`~@#$%^&*()\-_=\+\[\]\{\}\|\\<>\/]/g, ' ');
      
      // 3. 移除多余的星号、下划线等
      cleaned = cleaned.replace(/[*_\-]/g, ' ');
      
      // 4. 移除HTML标签（如果有）
      cleaned = cleaned.replace(/<[^>]*>/g, ' ');
      
      // 5. 移除数字编号如 "1."、"2)" 等
      cleaned = cleaned.replace(/\d+[\.\)]、/g, ' ');
      
      // 6. 标准化空白字符（多个空格变为一个空格）
      cleaned = cleaned.replace(/\s+/g, ' ').trim();
      
      // 7. 移除括号及其内容（可选，根据需求）
      cleaned = cleaned.replace(/\([^)]*\)/g, ' ')
                      .replace(/\[[^\]]*\]/g, ' ')
                      .replace(/\{[^}]*\}/g, ' ');
      
      // 8. 再次标准化空白字符
      cleaned = cleaned.replace(/\s+/g, ' ').trim();
      
      console.log('Text cleaned for speech:', {
        original: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
        cleaned: cleaned.substring(0, 100) + (cleaned.length > 100 ? '...' : ''),
        lengthReduction: text.length - cleaned.length
      });
      
      return cleaned;
    },
    
    // 检测文本语言
    detectLanguage(text) {
      if (!text) return this.lang === 'zh';
      
      // 如果设置了语言，优先使用设置的语言
      if (this.lang) {
        return this.lang === 'zh';
      }
      
      // 否则基于文本内容检测
      const chineseCharRegex = /[\u4e00-\u9fff]/;
      const englishWordRegex = /\b(the|and|for|this|that|with|from|science|paradigm|kuhn|ai)\b/i;
      
      const hasChinese = chineseCharRegex.test(text);
      const hasEnglish = englishWordRegex.test(text);
      
      // 如果有中文，优先使用中文
      if (hasChinese) return true;
      // 如果有英文关键词，使用英文
      if (hasEnglish) return false;
      // 默认使用当前界面语言
      return this.lang === 'zh';
    },
    
    // 朗读AI消息
    speakMessage(text, messageIndex) {
      // 如果正在朗读同一消息，则停止
      if (this.ttsPlayingIndex === messageIndex && this.currentSpeech) {
        window.speechSynthesis.cancel();
        this.ttsPlayingIndex = null;
        this.currentSpeech = null;
        return;
      }
      
      // 停止任何正在进行的朗读
      this.stopAllSpeech();
      
      // 清理文本（移除标点和表情）
      const cleanedText = this.cleanTextForSpeech(text);
      
      if (!cleanedText || cleanedText.length < 3) {
        this.showNotification(
          this.lang === 'zh' ? '文本内容过少，无法朗读' : 'Text too short to read',
          'error'
        );
        return;
      }
      
      // 检测消息语言
      const isChinese = this.detectLanguage(cleanedText);
      const langCode = isChinese ? 'zh-CN' : 'en-US';
      
      console.log('Speaking message:', {
        originalLength: text.length,
        cleanedLength: cleanedText.length,
        langCode: langCode,
        messageIndex: messageIndex
      });
      
      // 创建语音实例
      const utterance = new SpeechSynthesisUtterance(cleanedText);
      utterance.lang = langCode;
      utterance.rate = 0.9;  // 语速稍慢，便于理解
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      
      // 选择语音
      this.selectVoice(utterance, langCode);
      
      // 设置事件处理
      utterance.onstart = () => {
        this.ttsPlayingIndex = messageIndex;
        console.log('TTS started for message:', messageIndex);
      };
      
      utterance.onend = () => {
        this.ttsPlayingIndex = null;
        this.currentSpeech = null;
        console.log('TTS ended for message:', messageIndex);
      };
      
      utterance.onerror = (event) => {
        console.error('TTS error:', event);
        this.ttsPlayingIndex = null;
        this.currentSpeech = null;
        
        this.showNotification(
          this.lang === 'zh' 
            ? '语音朗读功能遇到问题。请检查浏览器设置或尝试使用其他浏览器。'
            : 'Text-to-speech encountered an issue. Please check browser settings or try another browser.',
          'error'
        );
      };
      
      // 保存当前语音对象并开始朗读
      this.currentSpeech = utterance;
      window.speechSynthesis.speak(utterance);
    },
    
    // 停止所有语音
    stopAllSpeech() {
      if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      }
      this.playingIdx = null;
      this.ttsPlayingIndex = null;
      this.currentSpeech = null;
    },
    
    // 选择语音
    selectVoice(utterance, langCode) {
      if (!('speechSynthesis' in window)) {
        console.warn('Speech synthesis not supported');
        return;
      }
      
      const voices = window.speechSynthesis.getVoices();
      
      if (voices.length === 0) {
        console.warn('No voices available');
        return;
      }
      
      // 优先选择匹配语言的语音
      const langPrefix = langCode.substring(0, 2);
      const langVoices = voices.filter(voice => 
        voice.lang.startsWith(langPrefix)
      );
      
      if (langVoices.length > 0) {
        // 如果有多种语音，选择听起来自然的
        const preferredVoices = langVoices.filter(voice => {
          const name = voice.name.toLowerCase();
          return name.includes('natural') || 
                 name.includes('female') || 
                 name.includes('google') ||
                 name.includes('microsoft') ||
                 name.includes('zira') || 
                 name.includes('samantha') ||
                 name.includes('tingting');
        });
        
        if (preferredVoices.length > 0) {
          utterance.voice = preferredVoices[0];
        } else {
          utterance.voice = langVoices[0];
        }
      } else {
        // 如果没有匹配语言的语音，使用默认语音
        console.warn(`No voice found for language ${langCode}, using default`);
        utterance.voice = voices[0];
      }
      
      console.log('Selected voice:', utterance.voice ? utterance.voice.name : 'default');
    },
    
    // 更新现有的章节TTS方法
    toggleTTS(text, idx) {
      // 清理章节文本
      const cleanedText = this.cleanTextForSpeech(text);
      
      if (this.playingIdx === idx && this.currentSpeech) {
        this.stopAllSpeech();
      } else {
        this.stopAllSpeech(); // 先停止其他语音
        
        const langCode = this.lang === 'zh' ? 'zh-CN' : 'en-US';
        const utterance = new SpeechSynthesisUtterance(cleanedText);
        utterance.lang = langCode;
        utterance.rate = 0.9;
        utterance.volume = 1.0;
        
        this.selectVoice(utterance, langCode);
        
        utterance.onend = () => {
          this.playingIdx = null;
          this.currentSpeech = null;
        };
        
        utterance.onerror = () => {
          this.playingIdx = null;
          this.currentSpeech = null;
        };
        
        this.currentSpeech = utterance;
        this.playingIdx = idx;
        window.speechSynthesis.speak(utterance);
      }
    },
    
    // 显示通知
    showNotification(message, type = 'info') {
      // 移除现有通知
      const existing = document.querySelector('.notification');
      if (existing) {
        existing.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (existing.parentNode) {
            existing.parentNode.removeChild(existing);
          }
        }, 300);
      }
      
      // 创建新通知元素
      const notification = document.createElement('div');
      notification.className = `notification ${type === 'error' ? 'error' : ''}`;
      notification.textContent = message;
      
      // 添加到页面
      document.body.appendChild(notification);
      
      // 3秒后移除
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    },
    
    // 切换聊天面板时停止语音
    toggleChat() {
      this.stopAllSpeech();
      this.chatOpen = !this.chatOpen;
      if (this.chatOpen) {
        this.$nextTick(() => {
          this.scrollToBottom();
        });
      }
    },
    
    closeChat() {
      this.stopAllSpeech();
      this.chatOpen = false;
    },
    
    // 发送消息时停止语音
    async sendMessage() {
      this.stopAllSpeech(); // 发送新消息前停止语音
      
      const input = this.userInput.trim();
      if (!input || this.isThinking) return;
      
      // 添加用户消息
      this.messages.push({ role: 'user', content: input });
      this.userInput = '';
      this.isThinking = true;
      this.scrollToBottom();
      
      try {
        // 调用后端API
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt: input,
            lang: this.lang,
            context: '科学范式转变、托马斯·库恩、AI时代认识论'
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        this.messages.push({ role: 'ai', content: data.reply });
        
      } catch (error) {
        console.error('AI请求失败:', error);
        const fallbackReply = this.lang === 'zh' 
          ? '抱歉，暂时无法连接到AI服务。您仍然可以浏览页面内容，了解科学范式转变的相关知识。'
          : 'Sorry, unable to connect to AI service at the moment. You can still browse the content to learn about scientific paradigm shifts.';
        this.messages.push({ role: 'ai', content: fallbackReply });
        
      } finally {
        this.isThinking = false;
        this.scrollToBottom();
      }
    },
    
    scrollToBottom() {
      this.$nextTick(() => {
        const container = this.$refs.chatScroll;
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      });
    },
    
    // 切换语言时停止语音
    toggleLanguage() {
      this.stopAllSpeech();
      this.lang = this.lang === 'zh' ? 'en' : 'zh';
      // 更新欢迎消息
      this.messages[0].content = this.lang === 'zh' 
        ? '你好！我是 AI 助手，我们可以探讨托马斯·库恩的科学范式理论、科学革命的结构，以及 AI 时代如何引发新的认识论变革。请随时提问！'
        : 'Hello! I am an AI assistant. We can discuss Thomas Kuhn\'s theory of scientific paradigms, the structure of scientific revolutions, and how the AI era is triggering new epistemological changes. Feel free to ask anything!';
    }
  },
  
  // 在组件销毁时停止语音
  beforeUnmount() {
    this.stopAllSpeech();
  }
}).mount('#app');
</script>
</body>
</html>